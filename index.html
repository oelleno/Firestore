<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이미지 업로드</title>
    <style>
        /* 기존 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.47059;
            font-weight: 400;
            letter-spacing: -.022em;
        }

        .container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        }

        h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #86868b;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #0071e3;
        }

        input[type="file"] {
            display: none;
        }

        .upload-button {
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 980px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .upload-button:hover {
            background-color: #0077ED;
        }

        .preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin-top: 20px;
            border-radius: 12px;
        }

        #loading {
            margin-top: 20px;
        }

        .spinner-border {
            width: 20px;
            height: 20px;
            border: 2px solid #0071e3;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* QR 코드 */
        .qr-container {
            margin-top: 20px;
            text-align: center;
        }

        #qrCode {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>이미지 업로드</h2>

        <div class="upload-area" id="dropZone">
            <label for="fileInput" class="upload-label">
                <span id="fileNameDisplay">이미지를 드래그하거나 클릭하여 선택하세요</span>
            </label>
            <input type="file" id="fileInput" accept="image/jpeg" class="d-none" onchange="showFileName(this)">
        </div>

        <img id="uploadedImage" class="preview" style="display:none" alt="미리보기">
        <button onclick="uploadImage()" class="upload-button">업로드</button>

        <div id="loading" style="display:none; text-align:center;">
            <div class="spinner-border"></div>
        </div>

        <div class="qr-container" id="qrContainer" style="display:none;">
            <h3>QR 코드 스캔으로 다운로드</h3>
            <div id="qrCode"></div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK 불러오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-storage.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyAxlXZTfOgO4ZrIfXp4t6sAjArTmMQrwuQ",
            authDomain: "fitgirlviki.firebaseapp.com",
            projectId: "fitgirlviki",
            storageBucket: "fitgirlviki.firebasestorage.app",
            messagingSenderId: "207468197936",
            appId: "1:207468197936:web:70ea3baa845e40372255f5"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        // 파일 업로드 함수
        window.uploadImage = async function () {
            const fileInput = document.getElementById("fileInput");
            if (!fileInput.files.length) {
                alert("파일을 선택하세요!");
                return;
            }

            const file = fileInput.files[0];
            const storageRef = ref(storage, `images/${file.name}`);
            document.getElementById('loading').style.display = 'block';
            try {
                // Firebase Storage에 파일 업로드
                await uploadBytes(storageRef, file);
                console.log("파일 업로드 완료!");

                // 업로드한 파일의 URL 가져오기
                const downloadURL = await getDownloadURL(storageRef);
                console.log("파일 다운로드 URL:", downloadURL);

                // 업로드 완료 후 이미지 표시
                const uploadedImage = document.getElementById("uploadedImage");
                uploadedImage.src = downloadURL;
                uploadedImage.style.display = "block";
                
                // 다운로드용 QR 코드 생성
                generateQRCode(downloadURL);

                // 업로드 완료 알림
                alert('이미지가 성공적으로 업로드되었습니다!');

            } catch (error) {
                alert('업로드 중 오류가 발생했습니다.');
                console.error("업로드 오류:", error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        };

        // QR 코드 생성 함수
        function generateQRCode(url) {
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.style.display = 'block';
            
            const qrCode = new QRCode(document.getElementById("qrCode"), {
                text: url, // 다운로드 URL을 QR 코드로 생성
                width: 128,
                height: 128,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
    </script>

    <!-- QR 코드 라이브러리 추가 -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</body>
</html>
